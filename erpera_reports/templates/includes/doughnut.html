<style>
  .doughnut-container {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 1.5rem 1.5rem 1rem 1.5rem;
    margin-bottom: 1.5rem;
    width: 100%;
    min-width: 260px;
    transition: box-shadow 0.2s;
  }
  .doughnut-container:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  }
  .doughnut-title {
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
    color: #374151;
    letter-spacing: 0.01em;
  }
  .doughnut-canvas {
    width: 100% !important;
    height: 260px !important;
    display: block;
  }
  .width-12 { flex: 0 0 100%; max-width: 100%; }
  .width-6  { flex: 0 0 50%;  max-width: 50%; }
  .width-4  { flex: 0 0 33.333%; max-width: 33.333%; }
  .width-3  { flex: 0 0 25%;  max-width: 25%; }
  .width-2  { flex: 0 0 16.666%; max-width: 16.666%; }
  @media (max-width: 1200px) {
    .width-12,
    .width-6,
    .width-4,
    .width-3,
    .width-2 {
      flex: 0 0 100%;
      max-width: 100%;
    }
  }
</style>
{% if chart_id and title and (data_url or (labels and data)) %}
<div class="doughnut-container width-{{ width|default(4) }}">
  <div class="doughnut-title">{{ title }}</div>
  <canvas id="{{ chart_id }}" class="doughnut-canvas"></canvas>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    function renderDoughnutChart_{{ chart_id }}(labels, data, backgroundColor) {
      new Chart(document.getElementById('{{ chart_id }}'), {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: backgroundColor || '{{ backgroundColor|default("#667eea") }}',
            offset: data.map(() => 0)
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'left',
              labels: {
                boxWidth: 12,
                padding: 8,
                font: {
                  size: 10
                },
                generateLabels: function(chart) {
                  const original = Chart.overrides.doughnut.plugins.legend.labels.generateLabels;
                  const labels = original(chart);
                  const hovered = chart.$_hoveredIndex;
                  return labels.map((label, idx) => {
                    if (hovered === idx) {
                      return Object.assign({}, label, {
                        fontColor: '#1d4ed8',
                        fontStyle: 'bold',
                        fillStyle: label.fillStyle,
                        strokeStyle: label.strokeStyle,
                        lineWidth: label.lineWidth
                      });
                    }
                    return label;
                  });
                }
              }
            }
          },
          onClick: function(evt, elements) {
            if (elements.length > 0) {
              const idx = elements[0].index;
              const label = this.data.labels[idx];
              const value = this.data.datasets[0].data[idx];
              if (typeof showDrillDownModal === 'function') {
                showDrillDownModal({ label, value }, '{{ title }}');
              }
            }
          },
          onHover: function(evt, activeEls) {
            const chart = this;
            const dataset = chart.data.datasets[0];
            if (!dataset._originalOffset) {
              dataset._originalOffset = dataset.offset ? [...dataset.offset] : dataset.data.map(() => 0);
            }
            if (activeEls && activeEls.length > 0) {
              const idx = activeEls[0].index;
              dataset.offset = dataset.data.map((_, i) => i === idx ? 20 : 0);
              chart.$_hoveredIndex = idx;
              chart.update('none');
            } else {
              dataset.offset = [...dataset._originalOffset];
              chart.$_hoveredIndex = null;
              chart.update('none');
            }
          },
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }
    {% if data_url %}
    var filters = {{ filters|tojson if filters is defined else 'null' }};
    var dataUrl = "{{ data_url }}";
    if (filters && Array.isArray(filters)) {
      var urlParams = new URLSearchParams(window.location.search);
      var filterQuery = '';
      filters.forEach(function(f) {
        if (urlParams.has(f.fieldname)) {
          filterQuery += (filterQuery ? '&' : '?') + encodeURIComponent(f.fieldname) + '=' + encodeURIComponent(urlParams.get(f.fieldname));
        }
      });
      if (filterQuery) {
        dataUrl += filterQuery;
      }
    }
    frappe.call({
      method: dataUrl,
      callback: function(r) {
        if (r.message) {
          renderDoughnutChart_{{ chart_id }}(
            r.message.labels,
            r.message.data,
            r.message.backgroundColor || '{{ backgroundColor|default("#667eea") }}'
          );
        }
      }
    });
    {% else %}
    renderDoughnutChart_{{ chart_id }}(
      {{ labels|tojson }},
      {{ data|tojson }},
      {{ backgroundColor|tojson|default('"#667eea"') }}
    );
    {% endif %}
  });
</script>
{% endif %} 