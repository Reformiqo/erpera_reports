{% extends 'erpera_reports/templates/pages/base.html' %}

{% block page_content %}
    <!-- Date Filter Section -->
    <div class="filter-section">
        <div><h1 style="margin: 0px;">Home Dashboard</h1></div>
        <div id="filter-box" class="filter-box">
            <button id="toggle-btn" class="toggle-btn">&gt;</button>
            <div class="filter-content">
                <div class="filter-container">
            <!-- <h3 class="filter-title">üîç Dashboard Filters</h3> -->
            <div style="text-align:end;">
                <button id="filter-btn-open-close" class="filter-btn-open-close">Filter</button>
            </div>
            <!-- All Filters in One Line -->
            <div class="all-filters" id="all-filters">
            <div class="filter-row-main" id="filter-row-main">
                <!-- Date Range Filter -->
                <div class="filter-group">
                    <!-- <label class="filter-group-label">üìÖ Date Range:</label> -->
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-range="today" onclick="setDateRange('today')">1D</button>
                        <!-- <button class="filter-btn" data-range="yesterday" onclick="setDateRange('yesterday')">Yesterday</button> -->
                        <button class="filter-btn" data-range="this_week" onclick="setDateRange('this_week')">1W</button>
                        <!-- <button class="filter-btn" data-range="last_week" onclick="setDateRange('last_week')">Last Week</button> -->
                        <button class="filter-btn" data-range="this_month" onclick="setDateRange('this_month')">1M</button>
                        <!-- <button class="filter-btn" data-range="last_month" onclick="setDateRange('last_month')">Last Month</button> -->
                        <button class="filter-btn" data-range="this_quarter" onclick="setDateRange('this_quarter')">3M</button>
                        <button class="filter-btn" data-range="last_quarter" onclick="setDateRange('last_quarter')">6M</button>
                        <button class="filter-btn" data-range="this_year" onclick="setDateRange('this_year')">1Y</button>
                        <!-- <button class="filter-btn" data-range="last_year" onclick="setDateRange('last_year')">Last Year</button> -->
                        <button class="filter-btn custom" data-range="custom" onclick="showCustomDatePicker()">Custom Range</button>
                    </div>
                </div>
                
                <!-- Company and Branch Filters -->
                <div class="filter-group">
                    <!-- <label class="filter-group-label">üè¢ Company:</label> -->
                    <select id="companyFilter" class="filter-select" style="width: 180px; min-width: 120px; max-width: 200px;" onchange="setCompanyFilter()">
                        <option value="">All Companies</option>
                        {% for company in company_list %}
                            <option value="{{ company.value }}">{{ company.label }}</option>
                        {% endfor %}
                    </select>
                    <!-- <label class="filter-group-label">üè™ Branch:</label> -->
                    <select id="branchFilter" class="filter-select" style="width: 180px; min-width: 120px; max-width: 200px;" onchange="setBranchFilter()">
                        <option value="">All Branches</option>
                        {% for branch in branch_list %}
                            <option value="{{ branch.value }}">{{ branch.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
            </div>

            <div class="custom-date-picker" id="customDatePicker" style="display: none;">
                <div class="date-inputs">
                    <div class="date-input-group">
                        <label for="fromDate">From Date:</label>
                        <input type="date" id="fromDate" class="date-input">
                    </div>
                    <div class="date-input-group">
                        <label for="toDate">To Date:</label>
                        <input type="date" id="toDate" class="date-input">
                    </div>
                    <button class="apply-btn" onclick="applyCustomDateRange()">Apply</button>
                </div>
            </div>

            <div class="current-range-display" id="currentFiltersBar">
                <span id="currentRangeText">Showing: This Month</span>
                <span id="filterChips"></span>
            </div> 
                </div>
            </div>
        </div>
    </div>
    </div>

    <div class="overview-cards">
        <!-- Sales Area -->
         <a href="/reports/selling/index" style="text-decoration: none;">
        <div class="card clickable-card" onclick="showCostCenterModal('total_sales')" style="background: linear-gradient(135deg, #c0ffc0 0%, #277c09 100%);">
            <div class="card-content">
                <div class="card-info">
                    <div class="card-value">{{ total_sales }}</div>
                    <div class="card-label">Total Sales</div>
                    <p style="color: #003489; font-size: 16px; font-weight: bold;">({{ current_month }})</p>
                </div>
                <div class="card-icon">‚Çπ</div>
            </div>
        </div>
        </a>
        <!-- Purchase Area -->
        <a href="/reports/buying/index" style="text-decoration: none;">
        <div class="card clickable-card" onclick="showCostCenterModal('total_amount')" style="background: linear-gradient(135deg, #ffc0c0 0%, #ff0000f5 100%);">
            <div class="card-content">
                <div class="card-info">
                    <div class="card-value">{{ total_amount }}</div>
                    <div class="card-label">Total Purchase</div>
                    <p style="color: #003489; font-size: 16px; font-weight: bold;">({{ current_month }})</p>
                </div>
                <div class="card-icon">üí∞</div>
            </div>
        </div>
        </a>
        <a href="/reports/expenses/index" style="text-decoration: none;">
        <div class="card clickable-card" onclick="showCostCenterModal('total_outstanding')" style="background: linear-gradient(135deg, #e9c0ff 0%, #67469b 100%);">
            <div class="card-content">
                <div class="card-info">
                    <div class="card-value">{{ total_outstanding }}</div>
                    <div class="card-label">Total Expense</div>
                    <p style="color: #003489; font-size: 16px; font-weight: bold;">({{ current_month }})</p>
                </div>
                <div class="card-icon">üíµ</div>
            </div>
        </div>
        </a>
        <a href="/reports/stock/index" style="text-decoration: none;">
        <div class="card clickable-card" onclick="showCostCenterModal('total_stock_value')" style="background: linear-gradient(135deg, #f5ba7e 0%, #7b4a0f 100%);">
            <div class="card-content">
                <div class="card-info">
                    <div class="card-value">{{ total_stock_value }}</div>
                    <div class="card-label">Stock Value</div>
                    <p style="color: #003489; font-size: 16px; font-weight: bold;">({{ current_month }})</p>
                </div>
                <div class="card-icon">üì¶</div>
            </div>
        </div>
        </a>
    </div>

 

    <div class="section-container">
        <h2 class="section-title">Top Selling & Low Performing SKUs</h2>
        <div class="charts-row">
            {% set chart_id = 'topSellingSkus' %}
            {% set title = 'Fast-Moving Items (By Quantity)' %}
            {% set backgroundColor = '#10b981' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.dashboard.get_top_selling_skus' %}
            {% set filters = [
              { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
              { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
              { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
              { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
            ] %}
            {% set drill_down_method = 'erpera_reports.api.get_selling_drill_down_data' %}
            {% set drill_down_title = 'Sales Details' %}
            {% include "erpera_reports/templates/includes/bar.html" %}

            {% set chart_id = 'lowPerformingSkus' %}
            {% set title = 'Slow-Moving Items (By Quantity)' %}
            {% set backgroundColor = '#ef4444' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.dashboard.get_low_performing_skus' %}
            {% set filters = [
              { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
              { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
              { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
              { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
            ] %}
            {% set drill_down_method = 'erpera_reports.api.get_selling_drill_down_data' %}
            {% set drill_down_title = 'Sales Details' %}
            {% include "erpera_reports/templates/includes/bar.html" %}
        </div>
        
        <div class="charts-row">
            {% set chart_id = 'topRevenueItems' %}
            {% set title = 'Top 20 Items by Revenue' %}
            {% set backgroundColor = '#8b5cf6' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.dashboard.get_top_revenue_items' %}
            {% set filters = [
              { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
              { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
              { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
              { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
            ] %}
            {% set drill_down_method = 'erpera_reports.api.get_selling_drill_down_data' %}
            {% set drill_down_title = 'Sales Details' %}
            {% include "erpera_reports/templates/includes/bar.html" %}

            {% set chart_id = 'itemCategoryPerformance' %}
            {% set title = 'Item Category Performance' %}
            {% set backgroundColor = '#f59e0b' %}
            {% set chart_type = 'doughnut' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.dashboard.get_item_category_performance' %}
            {% set filters = [
              { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
              { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
              { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
              { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
            ] %}
            {% set drill_down_method = 'erpera_reports.api.get_selling_drill_down_data' %}
            {% set drill_down_title = 'Sales Details' %}
            {% include "erpera_reports/templates/includes/doughnut.html" %}
        </div>
        
        <div class="charts-row">
            {% set chart_id = 'skuVelocityTrend' %}
            {% set title = 'SKU Velocity Trend (Top 10 Items - 30 Days)' %}
            {% set backgroundColor = '#06b6d4' %}
            {% set chart_type = 'line' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.dashboard.get_sku_velocity_trend' %}
            {% set filters = [
              { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
              { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
              { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
              { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
            ] %}
            {% set drill_down_method = 'erpera_reports.api.get_selling_drill_down_data' %}
            {% set drill_down_title = 'Sales Details' %}
            {% include "erpera_reports/templates/includes/line.html" %}
        </div>
    </div>

    
    <div class="section-container">
        <h2 class="section-title">Sales Summary Report</h2>
        <div class="charts-row">
            {% set chart_id = 'dailySalesSnapshot' %}
            {% set title = 'Sales Snapshot Across All Branches' %}
            {% set backgroundColor = '#22c55e' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.dashboard.get_daily_sales_snapshot' %}
            {% set filters = [
              { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list },
              { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list }
            ] %}
            {% set drill_down_method = 'erpera_reports.api.get_selling_drill_down_data' %}
            {% set drill_down_title = 'Sales Details' %}
            {% include "erpera_reports/templates/includes/bar.html" %}
        </div>
        
       
    </div>

   

    <div class="section-container">
        <h2 class="section-title">Purchase Analytics</h2>
        <div class="charts-row">
            {% set chart_id = 'topSuppliers' %}
            {% set title = 'Top Suppliers This Month' %}
            {% set backgroundColor = '#10b981' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.dashboard.get_top_suppliers' %}
            {% set filters = [
              { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
              { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
              { "label": "Limit", "fieldtype": "Select", "fieldname": "limit", "options": [
                {"value": "5", "label": "Top 5"},
                {"value": "10", "label": "Top 10"},
                {"value": "20", "label": "Top 20"}
              ] }
            ] %}
            {% set drill_down_method = 'erpera_reports.api.get_buying_drill_down_data' %}
            {% set drill_down_title = 'Purchase Details' %}
            {% include "erpera_reports/templates/includes/bar.html" %}

            
        </div>
    </div>

    <div class="section-container">
        <h2 class="section-title">Outstanding Analysis</h2>
        <div class="charts-row">
            {% set chart_id = 'outstandingBySupplier' %}
            {% set title = 'Outstanding by Supplier' %}
            {% set backgroundColor = '#ef4444' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.dashboard.get_outstanding_by_supplier' %}
            {% set filters = [
              { "label": "Limit", "fieldtype": "Select", "fieldname": "limit", "options": [
                {"value": "10", "label": "Top 10"},
                {"value": "20", "label": "Top 20"},
                {"value": "50", "label": "Top 50"}
              ] }
            ] %}
            {% set drill_down_method = 'erpera_reports.api.get_buying_drill_down_data' %}
            {% set drill_down_title = 'Purchase Details' %}
            {% include "erpera_reports/templates/includes/bar.html" %}

            
        </div>
    </div>

    

    <div class="section-container">
        <h2 class="section-title">Franchise Performance</h2>
        <div class="charts-row">
            {% set chart_id = 'franchisePerformance' %}
            {% set title = 'Franchise Performance' %}
            {% set backgroundColor = '#10b981' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.dashboard.get_branch_revenue_comparison' %}
            {% set filters = [
              { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
              { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
              { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list }
            ] %}
            {% set drill_down_method = 'erpera_reports.api.get_selling_drill_down_data' %}
            {% set drill_down_title = 'Sales Details' %}
            {% include "erpera_reports/templates/includes/bar.html" %}
        </div>
    </div>

    <div class="section-container">
        <h2 class="section-title">Monthly Trend</h2>
        <div class="charts-row">
            {% set chart_id = 'franchiseMonthlyTrend' %}
            {% set title = 'Monthly Trend' %}
            {% set width = 12 %}
            {% include "erpera_reports/templates/includes/line_franchise_performance.html" %}
        </div>
    </div>

    <div class="section-container">
        <h2 class="section-title">Sales Velocity Trends</h2>
        <div class="charts-row">
            {% set chart_id = 'salesVelocityTrends' %}
            {% set title = 'Sales Velocity Trends' %}
            {% set width = 12 %}
            {% include "erpera_reports/templates/includes/line_sales_velocity_trends.html" %}
        </div>
    </div>
    
    <style>
    /* Filter Section Styles */

    .filter-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }
    .all-filters {
      display: none;
    }
    .all-filters.active {
      display: block;
    }
    .all-filters label {
      display: block;
      margin-bottom: 8px;
    }
    .all-filters button {
      border: none;
    }
    .filter-btn-open-close {
    background: none;
    color: white;
    border: none;
    font-size: 27px;
    }
    .filter-row-main {
        display: flex;
        flex-flow: column;
        gap: 0.5rem;
        margin-bottom: 1rem;
        align-items: center;
    }

    .filter-box {
      position: fixed;
      top: 20px;
      right: -45%;
      transition: right 0.3s ease-in-out;
      z-index: 1000;
    }

    .filter-box.sticky {
      position: sticky;
      top: 20px;
    }

    .toggle-btn {
      position: absolute;
      top: 10px;
      left: -25px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px;
      cursor: pointer;
      font-size: 20px;
    }

    .filter-content button {
      /* margin-top: 20px;
      padding: 8px 15px;
      background-color: #007bff; */
      /* color: white; */
      border: none;
      cursor: pointer;
    }

    .filter-box.open {
      right: 0;
    }
    .toggle-btn.open {
      transform: rotate(180deg);
    }
    .filter-section{
      display: flex;
        flex-direction: row;
        padding: 35px;
    }
    .filter-container {
    background: #b08120 !important;
    border-radius: 8px;
    padding: 0.75rem;
    right: 20px;
  }
  
    .filter-container {
        max-width: 100%;
        right: 20px;
        display: flex;
    flex-flow: row-reverse;
    }

    .filter-section {
        display: flex;
        flex-direction: row;
    }


    .filter-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    

    .filter-group {
        display: flex;
    flex-direction: row;
    gap: 1rem;
    min-width: 140px;
    margin-bottom: 0;
    justify-content: center;
    }

    .filter-group-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.25rem;
        white-space: nowrap;
    }

    .filter-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        margin-bottom: 0;
    }

    .filter-btn {
        padding: 0.375rem 0.75rem;
        border: 1px solid #d1d5db;
        background: #fff;
        color: #374151;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 500;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .filter-btn:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
    }

    .filter-btn.active {
        background: #3b82f6;
        color: #fff;
        border-color: #3b82f6;
    }

    .filter-btn.custom {
        background: #f59e0b;
        color: #fff;
        border-color: #f59e0b;
        font-weight: bold;
    }

    .filter-btn.custom:hover {
        background: #d97706;
        border-color: #d97706;
        font-weight: bold;
    }

    .filter-select {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: #fff;
        color: #374151;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        width: 100%;
        transition: all 0.2s ease;
    }

    .filter-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .filter-select:hover {
        border-color: #9ca3af;
    }

    .custom-date-picker {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .date-inputs {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: end;
    }

    .date-input-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .date-input-group label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
    }

    .date-input {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 0.875rem;
    }

    .date-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .apply-btn {
        padding: 0.5rem 1rem;
        background: #10b981;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: background-color 0.2s ease;
    }

    .apply-btn:hover {
        background: #059669;
    }

    .current-range-display {
        margin-top: 1rem;
        padding: 0.75rem;
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 6px;
        text-align: center;
    }

    .current-range-display span {
        font-size: 0.875rem;
        font-weight: 500;
        color: #0369a1;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .filter-row-main {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }
        
        .filter-group {
            flex: none;
        }
        
        .filter-buttons {
            justify-content: flex-start;
        }
    }
    
    @media (max-width: 768px) {
        .filter-buttons {
            justify-content: center;
        }
        
        .filter-select {
            width: 100%;
        }
        
        .date-inputs {
            flex-direction: column;
            align-items: stretch;
        }
        
        .apply-btn {
            align-self: flex-start;
        }
    }

    .section-container {
        margin: 2rem 0;
        padding: 1rem;
        background: linear-gradient(135deg, #c0fffc 0%, #097c76 100%);
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #667eea;
    }

    .charts-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .clickable-card {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .clickable-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .dashboard-modal-content {
        max-height: 70vh;
        overflow-y: auto;
    }

    .dashboard-modal-content .overview-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        padding: 1rem 0;
    }

    .dashboard-modal-content .card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem 1.5rem 1.5rem 1.5rem;
        min-width: 0;
        /* min-height: 120px; */
        height: 100%;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        display: flex;
        align-items: stretch;
        flex: 1 1 0;
        transition: all 0.3s ease;
        position: relative;
    }

    .dashboard-modal-content .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .dashboard-modal-content .card-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .dashboard-modal-content .card-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }

    .dashboard-modal-content .card-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }

    /* Custom card icons */
    .card-icon.purchase-orders {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    }

    .card-icon.purchase-receipts {
        background: linear-gradient(135deg, #10b981, #047857);
    }

    .card-icon.purchase-invoices {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .card-icon.suppliers {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }

    .card-icon.outstanding {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    /* Growth indicators */
    .growth-indicator {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 12px;
        margin-top: 4px;
        display: inline-block;
        font-weight: 600;
    }

    .growth-indicator.positive {
        background: #dcfce7;
        color: #166534;
    }

    .growth-indicator.negative {
        background: #fef2f2;
        color: #dc2626;
    }

    .growth-indicator.neutral {
        background: #f3f4f6;
        color: #6b7280;
    }

    .filter-chip {
        display: inline-flex;
        align-items: center;
        background: #e0e7ff;
        color: #3730a3;
        border-radius: 16px;
        padding: 2px 10px 2px 8px;
        margin: 0 4px;
        font-size: 0.85em;
        font-weight: 500;
    }
    .chip-clear {
        background: none;
        border: none;
        color: #a21caf;
        font-size: 1em;
        margin-left: 4px;
        cursor: pointer;
        line-height: 1;
    }
    .chip-clear:hover {
        color: #dc2626;
    }

    .overview-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem 1.5rem 1.5rem 1.5rem;
        min-width: 0;
        min-height: 120px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        display: flex;
        align-items: stretch;
        flex: 1 1 0;
        transition: all 0.3s ease;
        position: relative;
        z-index: -1;
    }
    .card-content {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        height: 100%;
    }
    .card-info {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
        flex: 1;
        width: 120px;
    }
    .card-value {
        font-size: 2.1rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.25rem;
        line-height: 1.1;
        overflow-wrap: anywhere;
    }
    .card-label {
        color: #434c5e;
    font-weight: bold;
    font-size: 28px;
    margin-bottom: 0.25rem;
    }
    .card-icon {
        font-size: 4.5rem;
        display: flex;
        align-items: center;
        /* flex-shrink: 0; */
        height: 100%;
        background: rgba(0, 0, 0, .1);
    border-radius: 54px;
    width: 115px;
    justify-content: center;
    color: white;
    }
    @media (max-width: 900px) {
        .overview-cards {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    @media (max-width: 600px) {
        .overview-cards {
            grid-template-columns: 1fr;
        }
    }
    </style>
<script>
    const toggleBtn = document.getElementById('toggle-btn');
  const filterBox = document.getElementById('filter-box');

  // Toggle the filter box on button click
  toggleBtn.addEventListener('click', () => {
    filterBox.classList.toggle('open');
    toggleBtn.classList.toggle('open');  // Add or remove 'open' class for rotating the button
    // Change the button symbol based on the state
    if (filterBox.classList.contains('open')) {
      toggleBtn.innerHTML = '&lt;';  // Change to '<' when filter box is open
    } else {
      toggleBtn.innerHTML = '&gt;';  // Change to '>' when filter box is closed
    }
  });

  // Make the filter box sticky on scroll
  window.addEventListener('scroll', () => {
    if (window.scrollY > 100) {
      filterBox.classList.add('sticky');
    } else {
      filterBox.classList.remove('sticky');
    }
  });
    const filterBtn = document.getElementById('filter-btn-open-close');
    const filterOptions = document.getElementById('all-filters');
    filterBtn.addEventListener('click', () => {
      filterOptions.classList.toggle('active');
      if (filterOptions.classList.contains('active')) {
        filterBtn.innerHTML = '>';
      } else {
        filterBtn.innerHTML = 'Filter';
      }
    });
  </script>
    <script>
    // Date Range Filtering Functions
    let currentDateRange = 'this_month';
    let currentFromDate = null;
    let currentToDate = null;
    let currentCompany = '';
    let currentBranch = '';
    let isInitialLoad = true;

    // Initialize date range on page load
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const fromDate = urlParams.get('from_date');
        const toDate = urlParams.get('to_date');
        const company = urlParams.get('company');
        const branch = urlParams.get('branch');
        let range = 'this_month';

        // Try to match the range from the URL to a known range
        if (fromDate && toDate) {
            // Try to match to a known range
            const today = new Date();
            const from = new Date(fromDate);
            const to = new Date(toDate);
            const isToday = from.toDateString() === today.toDateString() && to.toDateString() === today.toDateString();
            if (isToday) {
                range = 'today';
            } else {
                // Detect 6m, 3m, 1w, etc. by comparing from/to
                const diffDays = Math.round((to - from) / (1000 * 60 * 60 * 24));
                if (diffDays >= 180 - 2 && diffDays <= 184) range = '6m';
                else if (diffDays >= 90 - 2 && diffDays <= 92) range = '3m';
                else if (diffDays >= 6 && diffDays <= 7) range = '1w';
                else range = 'custom';
            }
            currentFromDate = from;
            currentToDate = to;
            currentToDate.setHours(23, 59, 59);
        }
        setDateRange(range, false);

        // Set company filter if provided
        if (company) {
            currentCompany = company;
            const companySelect = document.getElementById('companyFilter');
            if (companySelect) {
                companySelect.value = company;
            }
        }

        // Set branch filter if provided
        if (branch) {
            currentBranch = branch;
            const branchSelect = document.getElementById('branchFilter');
            if (branchSelect) {
                branchSelect.value = branch;
            }
        }

        // Update filter display
        updateFilterDisplay();
        isInitialLoad = false;
    });

    function setDateRange(range, shouldRefresh = true) {
        currentDateRange = range;
        
        // Remove active class from all buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Add active class to clicked button
        const activeBtn = document.querySelector(`[data-range="${range}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
        
        // Calculate date range
        const dates = calculateDateRange(range);
        currentFromDate = dates.from;
        currentToDate = dates.to;
        
        // Update display
        updateRangeDisplay(range, dates);
        updateFilterDisplay();
        
        // Only refresh dashboard data if not initial load and shouldRefresh is true
        if (!isInitialLoad && shouldRefresh) {
            refreshDashboardData(dates.from, dates.to);
        }
    }

    function setCompanyFilter() {
        const companySelect = document.getElementById('companyFilter');
        currentCompany = companySelect ? companySelect.value : '';
        updateFilterDisplay();
        if (!isInitialLoad) {
            // Always get the latest from the URL, so we don't reset the range
            const urlParams = new URLSearchParams(window.location.search);
            let fromDate = urlParams.get('from_date');
            let toDate = urlParams.get('to_date');
            if (fromDate && toDate) {
                refreshDashboardData(new Date(fromDate), new Date(toDate));
            } else {
                refreshDashboardData(currentFromDate, currentToDate);
            }
        }
    }

    function setBranchFilter() {
        const branchSelect = document.getElementById('branchFilter');
        currentBranch = branchSelect ? branchSelect.value : '';
        updateFilterDisplay();
        if (!isInitialLoad) {
            // Always get the latest from the URL, so we don't reset the range
            const urlParams = new URLSearchParams(window.location.search);
            let fromDate = urlParams.get('from_date');
            let toDate = urlParams.get('to_date');
            if (fromDate && toDate) {
                refreshDashboardData(new Date(fromDate), new Date(toDate));
            } else {
                refreshDashboardData(currentFromDate, currentToDate);
            }
        }
    }

    function updateFilterDisplay() {
        // Update chips for selected filters
        const chipsContainer = document.getElementById('filterChips');
        let chipsHTML = '';

        // Date Range chip (only for custom)
        if (currentDateRange === 'custom') {
            const fromStr = currentFromDate ? currentFromDate.toLocaleDateString() : '';
            const toStr = currentToDate ? currentToDate.toLocaleDateString() : '';
            chipsHTML += `<span class='filter-chip'>Custom: ${fromStr} - ${toStr} <button class='chip-clear' onclick='clearDateFilter()' title='Clear'>√ó</button></span>`;
        }

        // Company chip
        if (currentCompany) {
            chipsHTML += `<span class='filter-chip'>Company: ${getCompanyName(currentCompany)} <button class='chip-clear' onclick='clearCompanyFilter()' title='Clear'>√ó</button></span>`;
        }

        // Branch chip
        if (currentBranch) {
            chipsHTML += `<span class='filter-chip'>Branch: ${getBranchName(currentBranch)} <button class='chip-clear' onclick='clearBranchFilter()' title='Clear'>√ó</button></span>`;
        }

        chipsContainer.innerHTML = chipsHTML;
    }

    function clearDateFilter() {
        setDateRange('this_month');
    }
    function clearCompanyFilter() {
        const companySelect = document.getElementById('companyFilter');
        if (companySelect) companySelect.value = '';
        setCompanyFilter();
    }
    function clearBranchFilter() {
        const branchSelect = document.getElementById('branchFilter');
        if (branchSelect) branchSelect.value = '';
        setBranchFilter();
    }

    function getCompanyName(companyValue) {
        const companySelect = document.getElementById('companyFilter');
        if (companySelect) {
            const option = companySelect.querySelector(`option[value="${companyValue}"]`);
            return option ? option.textContent : companyValue;
        }
        return companyValue;
    }

    function getBranchName(branchValue) {
        const branchSelect = document.getElementById('branchFilter');
        if (branchSelect) {
            const option = branchSelect.querySelector(`option[value="${branchValue}"]`);
            return option ? option.textContent : branchValue;
        }
        return branchValue;
    }

    function calculateDateRange(range) {
        const today = new Date();
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
        
        switch(range) {
            case 'today':
                return {
                    from: startOfDay,
                    to: endOfDay,
                    display: 'Today'
                };
                
            case 'yesterday':
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                return {
                    from: new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate()),
                    to: new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate(), 23, 59, 59),
                    display: 'Yesterday'
                };
                
            case 'this_week':
                const startOfWeek = new Date(today);
                const dayOfWeek = today.getDay();
                startOfWeek.setDate(today.getDate() - dayOfWeek);
                return {
                    from: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate()),
                    to: endOfDay,
                    display: 'This Week'
                };
                
            case 'last_week':
                const lastWeekStart = new Date(today);
                lastWeekStart.setDate(today.getDate() - dayOfWeek - 7);
                const lastWeekEnd = new Date(lastWeekStart);
                lastWeekEnd.setDate(lastWeekStart.getDate() + 6);
                return {
                    from: new Date(lastWeekStart.getFullYear(), lastWeekStart.getMonth(), lastWeekStart.getDate()),
                    to: new Date(lastWeekEnd.getFullYear(), lastWeekEnd.getMonth(), lastWeekEnd.getDate(), 23, 59, 59),
                    display: 'Last Week'
                };
                
            case 'this_month':
                // get the last 30 days instead of this month 
                const last30Days = new Date(today);
                last30Days.setDate(today.getDate() - 30);
                return {
                    from: last30Days,
                    to: endOfDay,
                    display: 'Last 30 Days'
                };
                
            case 'last_month':
                const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                return {
                    from: lastMonth,
                    to: new Date(lastMonthEnd.getFullYear(), lastMonthEnd.getMonth(), lastMonthEnd.getDate(), 23, 59, 59),
                    display: 'Last Month'
                };
                
            case 'this_quarter':
            case '3m': {
                // Last 3 months from today (same day-of-month or last valid day)
                const threeMonthsAgo = new Date(today);
                const targetMonth = today.getMonth() - 3;
                threeMonthsAgo.setMonth(targetMonth);
                if (threeMonthsAgo.getMonth() !== ((targetMonth + 12) % 12)) {
                    threeMonthsAgo.setDate(0);
                }
                return {
                    from: threeMonthsAgo,
                    to: endOfDay,
                    display: 'Last 3 Months'
                };
            }
            case 'last_quarter':
                const lastQuarter = Math.floor((today.getMonth() - 3) / 3);
                const lastQuarterStart = new Date(today.getFullYear(), lastQuarter * 3, 1);
                const lastQuarterEnd = new Date(today.getFullYear(), (lastQuarter + 1) * 3, 0);
                return {
                    from: lastQuarterStart,
                    to: new Date(lastQuarterEnd.getFullYear(), lastQuarterEnd.getMonth(), lastQuarterEnd.getDate(), 23, 59, 59),
                    display: 'Last Quarter'
                };
                
            case 'this_year':
                // get the last 365 days instead of this year 
                const last365Days = new Date(today);
                last365Days.setDate(today.getDate() - 365);
                return {
                    from: last365Days,
                    to: endOfDay,
                    display: 'Last 365 Days'
                };
                
            case 'last_year':
                const lastYearStart = new Date(today.getFullYear() - 1, 0, 1);
                const lastYearEnd = new Date(today.getFullYear() - 1, 11, 31);
                return {
                    from: lastYearStart,
                    to: new Date(lastYearEnd.getFullYear(), lastYearEnd.getMonth(), lastYearEnd.getDate(), 23, 59, 59),
                    display: 'Last Year'
                };
                
            case '6m': {
                // Last 6 months from today (same day-of-month or last valid day)
                const sixMonthsAgo = new Date(today);
                const targetMonth = today.getMonth() - 6;
                sixMonthsAgo.setMonth(targetMonth);
                if (sixMonthsAgo.getMonth() !== ((targetMonth + 12) % 12)) {
                    sixMonthsAgo.setDate(0);
                }
                return {
                    from: sixMonthsAgo,
                    to: endOfDay,
                    display: 'Last 6 Months'
                };
            }
            default:
                return {
                    from: new Date(today.getFullYear(), today.getMonth(), 1),
                    to: endOfDay,
                    display: 'This Month'
                };
        }
    }

    function updateRangeDisplay(range, dates) {
        const displayText = document.getElementById('currentRangeText');
        if (displayText) {
            const fromStr = dates.from.toLocaleDateString();
            const toStr = dates.to.toLocaleDateString();
            displayText.textContent = `Showing: ${dates.display} (${fromStr} - ${toStr})`;
        }
    }

    function showCustomDatePicker() {
        const picker = document.getElementById('customDatePicker');
        if (picker) {
            picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
        }
        
        // Set default dates (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        document.getElementById('fromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        document.getElementById('toDate').value = today.toISOString().split('T')[0];
    }

    function applyCustomDateRange() {
        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;
        
        if (!fromDate || !toDate) {
            frappe.msgprint({
                title: 'Invalid Date Range',
                message: 'Please select both from and to dates.',
                indicator: 'red'
            });
            return;
        }
        
        if (new Date(fromDate) > new Date(toDate)) {
            frappe.msgprint({
                title: 'Invalid Date Range',
                message: 'From date cannot be after to date.',
                indicator: 'red'
            });
            return;
        }
        
        // Check if dates have actually changed
        const newFromDate = new Date(fromDate);
        const newToDate = new Date(toDate);
        newToDate.setHours(23, 59, 59);
        
        if (currentFromDate && currentToDate) {
            const fromChanged = currentFromDate.toISOString().split('T')[0] !== fromDate;
            const toChanged = currentToDate.toISOString().split('T')[0] !== toDate;
            
            if (!fromChanged && !toChanged) {
                // Dates haven't changed, just hide the picker
                document.getElementById('customDatePicker').style.display = 'none';
                return;
            }
        }
        
        currentFromDate = newFromDate;
        currentToDate = newToDate;
        
        // Update display
        const displayText = document.getElementById('currentRangeText');
        if (displayText) {
            displayText.textContent = `Showing: Custom Range (${fromDate} - ${toDate})`;
        }
        
        // Hide custom picker
        document.getElementById('customDatePicker').style.display = 'none';
        
        // Only refresh if not initial load
        if (!isInitialLoad) {
            refreshDashboardData(currentFromDate, currentToDate);
        }
    }

    function refreshDashboardData(fromDate, toDate) {
        // Show loading indicator
        frappe.show_alert('Refreshing dashboard data...', 2);
        
        // Convert dates to ISO string for API calls
        const fromDateStr = fromDate.toISOString().split('T')[0];
        const toDateStr = toDate.toISOString().split('T')[0];
        
        // Refresh all charts with new date range
        // This will trigger a page reload with new date parameters
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('from_date', fromDateStr);
        currentUrl.searchParams.set('to_date', toDateStr);
        
        // Add company and branch parameters if selected
        if (currentCompany) {
            currentUrl.searchParams.set('company', currentCompany);
        } else {
            currentUrl.searchParams.delete('company');
        }
        
        if (currentBranch) {
            currentUrl.searchParams.set('branch', currentBranch);
        } else {
            currentUrl.searchParams.delete('branch');
        }
        
        // Debug: log the filters being sent
        console.log('Refreshing with filters:', {
            from_date: fromDateStr,
            to_date: toDateStr,
            company: currentCompany,
            branch: currentBranch
        });
        
        // Reload the page with new parameters
        window.location.href = currentUrl.toString();
    }

    // Store data from server with error handling
    let salesData = [];
    let purchaseData = [];
    let stockData = [];
    
    try {
        salesData = JSON.parse('{{ sales_details | tojson | safe }}') || [];
        purchaseData = JSON.parse('{{ purchase_details | tojson | safe }}') || [];
        stockData = JSON.parse('{{ stock_details | tojson | safe }}') || [];
    } catch (e) {
        console.error('Error parsing data:', e);
        salesData = [];
        purchaseData = [];
        stockData = [];
    }
    
    console.log('Sales Data:', salesData);
    console.log('Purchase Data:', purchaseData);
    console.log('Stock Data:', stockData);
    </script>

<!-- Ensure showCostCenterModal is globally available -->
<script>
window.showCostCenterModal = function(metricType) {
    // Determine which data array to use
    let dataArr = [];
    let title = '';
    let icon = '';
    if (metricType === 'total_sales') {
        dataArr = salesData;
        title = 'Total Sales by Branch';
        icon = '‚Çπ';
    } else if (metricType === 'total_amount') {
        dataArr = purchaseData;
        title = 'Total Purchase by Branch';
        icon = 'üí∞';
    } else if (metricType === 'total_outstanding') {
        dataArr = purchaseData;
        title = 'Total Expense by Branch';
        icon = 'üíµ';
    } else if (metricType === 'total_stock_value') {
        dataArr = stockData;
        title = 'Stock Value by Warehouse';
        icon = 'üì¶';
    } else {
        frappe.msgprint({
            title: 'No Data',
            message: 'No data available for this metric.',
            indicator: 'red'
        });
        return;
    }

    if (!dataArr || dataArr.length === 0) {
        frappe.msgprint({
            title: 'No Data Available',
            message: 'No data is currently available for this period.',
            indicator: 'red'
        });
        return;
    }

    // Build modal content
    let cardsHTML = '<div class="dashboard-modal-content">';
    cardsHTML += '<div class="overview-cards">';
    dataArr.forEach(function(item) {
        const value = item[metricType] || 'N/A';
        cardsHTML += '<div class="card">';
        cardsHTML += '<div class="card-icon">' + icon + '</div>';
        cardsHTML += '<div class="card-value">' + value + '</div>';
        cardsHTML += '<div class="card-label">' + (item.display_name || item.name || 'Unknown') + '</div>';
        cardsHTML += '</div>';
    });
    cardsHTML += '</div></div>';

    frappe.msgprint({
        title: title,
        message: cardsHTML,
        wide: true,
        indicator: 'blue'
    });
}
</script>

{% endblock %}
