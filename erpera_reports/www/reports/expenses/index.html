{% extends 'erpera_reports/templates/pages/base.html' %}

{% block page_content %}
    <!-- Filter Section (copied and adapted from reports/selling/index.html) -->
    
    <div class="filter-section">
        <div><h1 style="margin: 0px;">Expenses Dashboard</h1></div>
        <div id="filter-box" class="filter-box">
            <button id="toggle-btn" class="toggle-btn">&gt;</button>
            <div class="filter-content">
                <div class="filter-container">
                    <div class="filter-row-main">
                        <div class="filter-container">
                            <div style="text-align:end;">
                                <button id="filter-btn-open-close" class="filter-btn-open-close"><img src="https://openmoji.org/data/color/svg/E257.svg" alt="Filter" style="width:40px; height:auto;"></button>
                            </div>
                            <div class="all-filters" id="all-filters">
                                <div class="filter-row-main" id="filter-row-main">
                                    <div class="filter-group">
                                        <div class="filter-buttons">
                                            <button class="filter-btn active" data-range="1d" onclick="setDateRange('today')">1D</button>
                                            <button class="filter-btn" data-range="1w" onclick="setDateRange('1w')">1W</button>
                                            <button class="filter-btn" data-range="1m" onclick="setDateRange('1m')">1M</button>
                                            <button class="filter-btn" data-range="3m" onclick="setDateRange('3m')">3M</button>
                                            <button class="filter-btn" data-range="6m" onclick="setDateRange('6m')">6M</button>
                                            <button class="filter-btn" data-range="1y" onclick="setDateRange('1y')">1Y</button>
                                            <button class="filter-btn custom" data-range="custom" onclick="showCustomDatePicker()">Custom Range</button>
                                        </div>
                                    </div>
                                    <div class="filter-group">
                                        <select id="companyFilter" class="filter-select" style="width: 180px; min-width: 120px; max-width: 200px;" onchange="setCompanyFilter()">
                                            <option value="">All Companies</option>
                                            {% for company in company_list %}
                                                <option value="{{ company.value }}">{{ company.label }}</option>
                                            {% endfor %}
                                        </select>
                                        <select id="branchFilter" class="filter-select" style="width: 180px; min-width: 120px; max-width: 200px;" onchange="setBranchFilter()">
                                            <option value="">All Branches</option>
                                            {% for branch in branch_list %}
                                                <option value="{{ branch.value }}">{{ branch.label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="custom-date-picker" id="customDatePicker" style="display: none;">
                                    <div class="date-inputs">
                                        <div class="date-input-group">
                                            <label for="fromDate">From Date:</label>
                                            <input type="date" id="fromDate" class="date-input">
                                        </div>
                                        <div class="date-input-group">
                                            <label for="toDate">To Date:</label>
                                            <input type="date" id="toDate" class="date-input">
                                        </div>
                                        <button class="apply-btn" onclick="applyCustomDateRange()">Apply</button>
                                    </div>
                                </div>
                                <div class="current-range-display" id="currentFiltersBar">
                                    <span id="currentRangeText">Showing: This Month</span>
                                    <span id="filterChips"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

<div class="overview-cards">
    <div class="card clickable-card" onclick="showCostCenterModal('total_expense')">
        <div class="card-content">
            <div class="card-info">
                <div class="card-value">{{ total_expense }}</div>
                <div class="card-label">Total Expense</div>
                <p style="color: #dc2626; font-size: 16px; font-weight: bold;">({{ current_fiscal_year }})</p>
            </div>
            <div class="card-icon">üí∏</div>
        </div>
    </div>
    <div class="card clickable-card" onclick="showCostCenterModal('total_salaries')">
        <div class="card-content">
            <div class="card-info">
                <div class="card-value">{{ total_salaries }}</div>
                <div class="card-label">Total Salaries</div>
                <p style="color: #dc2626; font-size: 16px; font-weight: bold;">({{ current_fiscal_year }})</p>
            </div>
            <div class="card-icon">üë•</div>
        </div>
    </div>
    <div class="card clickable-card" onclick="showCostCenterModal('total_rents')">
        <div class="card-content">
            <div class="card-info">
                <div class="card-value">{{ total_rents }}</div>
                <div class="card-label">Total Rents</div>
                <p style="color: #dc2626; font-size: 16px; font-weight: bold;">({{ current_fiscal_year }})</p>
            </div>
            <div class="card-icon">üè¢</div>
        </div>
    </div>
    <div class="card clickable-card" onclick="showCostCenterModal('total_electric_bill')">
        <div class="card-content">
            <div class="card-info">
                <div class="card-value">{{ total_electric_bill }}</div>
                <div class="card-label">Total Electric Bill</div>
                <p style="color: #dc2626; font-size: 16px; font-weight: bold;">({{ current_fiscal_year }})</p>
            </div>
            <div class="card-icon">‚ö°</div>
        </div>
    </div>
</div>

<div class="section-container">
    <h2 class="section-title">Expense Analysis</h2>
    <div class="charts-row">
        {% set chart_id = 'expenseByBranch' %}
        {% set title = 'Expense by Branch' %}
        {% set backgroundColor = '#dc2626' %}
        {% set chart_type = 'bar' %}
        {% set width = 12 %}
        {% set data_url = 'erpera_reports.expense.get_expense_by_branch' %}
        {% set filters = [
          { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
          { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
          { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
          { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
        ] %}
		{% set drill_down_method = 'erpera_reports.api.get_expense_drill_down_data' %}
        {% set drill_down_title = 'Expense Details' %}
        {% include "erpera_reports/templates/includes/bar.html" %}

        {% set chart_id = 'expenseByCompany' %}
        {% set title = 'Expense by Company' %}
        {% set backgroundColor = '#dc2626' %}
        {% set chart_type = 'bar' %}
        {% set width = 12 %}
        {% set data_url = 'erpera_reports.expense.get_expense_by_company' %}
        {% set filters = [
            { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
            { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
            { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list }
        ] %}
		{% set drill_down_method = 'erpera_reports.api.get_expense_drill_down_data' %}
        {% set drill_down_title = 'Expense Details' %}
        {% include "erpera_reports/templates/includes/bar.html" %}

        {% set chart_id = 'expenseSummary' %}
        {% set title = 'Expense Summary' %}
        {% set backgroundColor = '#dc2626' %}
        {% set chart_type = 'bar' %}
        {% set width = 12 %}
        {% set data_url = 'erpera_reports.expense.get_expense_summary' %}
        {% set filters = [
          { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
          { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
          { "label": "Expense Head", "fieldtype": "Select", "fieldname": "item_group", "options": item_group_list },
          { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
          { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
        ] %}
		{% set drill_down_method = 'erpera_reports.api.get_expense_drill_down_data' %}
        {% set drill_down_title = 'Expense Details' %}
        {% include "erpera_reports/templates/includes/bar.html" %}
    </div>
</div>
<div class="section-container">
    <h2 class="section-title">Most Expenses Head</h2>
    <div class="charts-row">
        {% set chart_id = 'mostExpensesHeadByBranch' %}
        {% set title = 'Most Expenses Head by Branch' %}
        {% set data_url = 'erpera_reports.buying.get_most_expenses_head_by_branch' %}
        {% set width = 12 %}
        {% set filters = [
            { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
            { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
            { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
            { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list },
            { "label": "Item Group", "fieldtype": "Select", "fieldname": "item_group", "options": item_group_list }
        ] %}
        {% set drill_down_method = 'erpera_reports.api.get_expense_drill_down_data' %}
        {% set drill_down_title = 'Expense Details' %}
        {% include "erpera_reports/templates/includes/multi_pie.html" %}

        {% set chart_id = 'mostExpensesHeadByCompany' %}
        {% set title = 'Most Expenses Head by Company' %}
        {% set data_url = 'erpera_reports.buying.get_most_expenses_head_by_company' %}
        {% set width = 12 %}
        {% set filters = [
            { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
            { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
            { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
            { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list },
            { "label": "Item Group", "fieldtype": "Select", "fieldname": "item_group", "options": item_group_list }
        ] %}
        {% set drill_down_method = 'erpera_reports.api.get_expense_drill_down_data' %}
        {% set drill_down_title = 'Expense Details' %}
        {% include "erpera_reports/templates/includes/multi_pie.html" %}
    </div>
</div>

<div class="section-container">
    <h2 class="section-title">Consolidate Most Purchase Head</h2>
    <div class="charts-row">
        {% set chart_id = 'consolidateMostPurchaseHead' %}
        {% set title = 'Top 10 Expense Categories Overall' %}
        {% set backgroundColor = '#059669' %}
        {% set chart_type = 'pie' %}
        {% set width = 12 %}
        {% set data_url = 'erpera_reports.buying.get_consolidate_most_purchase_head' %}
        {% set filters = [
            { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
            { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
            { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
            { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list },
            { "label": "Item Group", "fieldtype": "Select", "fieldname": "item_group", "options": item_group_list }
        ] %}
		{% set drill_down_method = 'erpera_reports.api.get_expense_drill_down_data' %}
        {% set drill_down_title = 'Expense Details' %}
        {% include "erpera_reports/templates/includes/doughnut.html" %}
    </div>
</div>
<div class="section-container">
    <h2 class="section-title">Consolidate Most Purchase Head</h2>
    <div class="charts-row">

        {% set chart_id = 'mostExpensesHeadByCompany' %}
        {% set title = 'Most Expenses Head by Company' %}
        {% set data_url = 'erpera_reports.buying.get_most_expenses_head_by_company' %}
        {% set width = 12 %}
        {% set filters = [
            { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
            { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
            { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
            { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list },
            { "label": "Item Group", "fieldtype": "Select", "fieldname": "item_group", "options": item_group_list }
        ] %}
        {% set drill_down_method = 'erpera_reports.api.get_expense_drill_down_data' %}
        {% set drill_down_title = 'Expense Details' %}
        {% include "erpera_reports/templates/includes/multi_pie.html" %}
    </div>
</div>

<div class="section-container">
    <h2 class="section-title">Consolidate Most Purchase Head</h2>
    <div class="charts-row">
        {% set chart_id = 'consolidateMostPurchaseHead' %}
        {% set title = 'Top 10 Expense Categories Overall' %}
        {% set backgroundColor = '#059669' %}
        {% set chart_type = 'pie' %}
        {% set width = 12 %}
        {% set data_url = 'erpera_reports.buying.get_consolidate_most_purchase_head' %}
        {% set filters = [
            { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
            { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
            { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
            { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list },
            { "label": "Item Group", "fieldtype": "Select", "fieldname": "item_group", "options": item_group_list }
        ] %}
		{% set drill_down_method = 'erpera_reports.api.get_expense_drill_down_data' %}
        {% set drill_down_title = 'Expense Details' %}
        {% include "erpera_reports/templates/includes/doughnut.html" %}
    </div>
</div>
<style>

.filter-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }
    .all-filters {
      display: none;
    }
    .all-filters.active {
      display: block;
    }
    .all-filters label {
      display: block;
      margin-bottom: 8px;
    }
    .all-filters button {
      border: none;
    }
    .filter-btn-open-close {
    background: none;
    color: white;
    border: none;
    font-size: 27px;
    }
    .filter-row-main {
        display: flex;
        flex-flow: column;
        gap: 0.5rem;
        margin-bottom: 1rem;
        align-items: center;
    }
    
    .filter-container {
        max-width: 100%;
        right: 20px;
        display: flex;
    flex-flow: row-reverse;
    }

    .filter-section {
        display: flex;
        flex-direction: row;
    }

    

    .filter-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }


.filter-row-main { 
        display: flex;
        flex-flow: column;
        gap: 0.5rem;
        margin-bottom: 1rem;
        align-items: center;
    }
    .filter-group {
    display: flex;
    flex-direction: row;
    gap: 1rem;
    min-width: 140px;
    margin-bottom: 0;
    justify-content: center;
}
.filter-group-label { display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem; white-space: nowrap; }
    .filter-buttons { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 0; }
    .filter-btn { padding: 0.375rem 0.75rem; border: 1px solid #d1d5db; background: #fff; color: #374151; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: all 0.2s ease; white-space: nowrap; }
    .filter-btn:hover { background: #f3f4f6; border-color: #9ca3af; }
    .filter-btn.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }
    .filter-btn.custom { background: #f59e0b; color: #fff; border-color: #f59e0b;font-weight: bold; }
    .filter-btn.custom:hover { background: #d97706; border-color: #d97706; font-weight: bold;}
    .filter-select { padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; color: #374151; font-size: 0.875rem; font-weight: 500; cursor: pointer; width: 100%; transition: all 0.2s ease; }
    .filter-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .filter-select:hover { border-color: #9ca3af; }
    .custom-date-picker { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; margin-top: 1rem; }
    .date-inputs { display: flex; flex-wrap: wrap; gap: 1rem; align-items: end; }
    .date-input-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .date-input-group label { font-size: 0.875rem; font-weight: 500; color: #374151; }
    .date-input { padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem; }
    .date-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .apply-btn { padding: 0.5rem 1rem; background: #10b981; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: background-color 0.2s ease; }
    .apply-btn:hover { background: #059669; }
    .current-range-display { margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; text-align: center; }
    .current-range-display span { font-size: 0.875rem; font-weight: 500; color: #0369a1; }
    .filter-chip { display: inline-flex; align-items: center; background: #e0e7ff; color: #3730a3; border-radius: 16px; padding: 2px 10px 2px 8px; margin: 0 4px; font-size: 0.85em; font-weight: 500; }
    .chip-clear { background: none; border: none; color: #a21caf; font-size: 1em; margin-left: 4px; cursor: pointer; line-height: 1; }
    .chip-clear:hover { color: #dc2626; }




    .filter-box {
      position: fixed;
      top: 20px;
      right: -45%;
      transition: right 0.3s ease-in-out;
      z-index: 1000;
    }

    .filter-box.sticky {
      position: sticky;
      top: 20px;
    }

    .toggle-btn {
      position: absolute;
      top: 10px;
      left: -25px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px;
      cursor: pointer;
      font-size: 20px;
    }

    .filter-content button {
      /* margin-top: 20px;
      padding: 8px 15px;
      background-color: #007bff; */
      /* color: white; */
      border: none;
      cursor: pointer;
    }

    .filter-box.open {
      right: 0;
    }
    .toggle-btn.open {
      transform: rotate(180deg);
    }
    .filter-section{
      display: flex;
        flex-direction: row;
        padding: 35px;
    }
    .filter-container {
    background: #b08120 !important;
    border-radius: 8px;
    padding: 0.75rem;
    right: 20px;
  }




.section-container {
    margin: 2rem 0;
    padding: 1rem;
    background: linear-gradient(135deg, #f9e3ff 0%, #67469b 100%);
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #dc2626;
}
.charts-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
}
.clickable-card {
    cursor: pointer;
    transition: all 0.3s ease;
}
.clickable-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.overview-cards {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
}
.overview-cards, .overview-cards * {
  pointer-events: auto !important;
  z-index: 10 !important;
}
.card, .card * {
  pointer-events: auto !important;
}
.card {
    background: linear-gradient(135deg, #e9c0ff 0%, #67469b 100%);
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem 1.5rem 1.5rem 1.5rem;
    min-width: 220px;
    min-height: 120px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    display: flex;
    align-items: stretch;
    flex: 1 1 220px;
    transition: all 0.3s ease;
    position: relative;
    z-index: -1;
}
.card-content {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    height: 100%;
}
.card-info {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: center;
    flex: 1;
    width: 120px;
}
.card-value {
    font-size: 2.1rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.25rem;
    line-height: 1.1;
    overflow-wrap: anywhere;
}
.card-label {
    color: #434c5e;
    font-weight: bold;
    font-size: 28px;
    margin-bottom: 0.25rem;
}
.card-icon {
    font-size: 4.5rem;
    display: flex;
    align-items: center;
    /* flex-shrink: 0; */
    height: 100%;
    background: rgba(0, 0, 0, .1);
    border-radius: 54px;
    width: 115px;
    justify-content: center;
    color: #dc2626;
}
.cost-center-modal-content {
        max-height: 70vh;
        overflow-y: auto;
    }
    .cost-center-modal-content .overview-cards {
            display: grid;
            grid-template-columns: repeat(4, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1rem 0;
        }
.cost-center-modal-content .card {
    background: linear-gradient(135deg, #e9c0ff 0%, #67469b 100%);
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}
    .cost-center-modal-content .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .cost-center-modal-content .card-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .cost-center-modal-content .card-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }
    .modal .modal-header .modal-title {
    font-size: xx-large;
    font-weight: bold;
    width: 100%;
    text-align: center;
}
</style>
<script>
    const toggleBtn = document.getElementById('toggle-btn');
  const filterBox = document.getElementById('filter-box');

  // Toggle the filter box on button click
  toggleBtn.addEventListener('click', () => {
    filterBox.classList.toggle('open');
    toggleBtn.classList.toggle('open');  // Add or remove 'open' class for rotating the button
    // Change the button symbol based on the state
    if (filterBox.classList.contains('open')) {
      toggleBtn.innerHTML = '&lt;';  // Change to '<' when filter box is open
    } else {
      toggleBtn.innerHTML = '&gt;';  // Change to '>' when filter box is closed
    }
  });

  // Make the filter box sticky on scroll
  window.addEventListener('scroll', () => {
    if (window.scrollY > 100) {
      filterBox.classList.add('sticky');
    } else {
      filterBox.classList.remove('sticky');
    }
  });
    
    const filterBtn = document.getElementById('filter-btn-open-close');
    const filterOptions = document.getElementById('all-filters');
    filterBtn.addEventListener('click', () => {
      filterOptions.classList.toggle('active');
      if (filterOptions.classList.contains('active')) {
        filterBtn.innerHTML = '>';
      } else {
        filterBtn.innerHTML = '<img src="https://openmoji.org/data/color/svg/E257.svg" alt="Filter" style="width:40px; height:auto;">';
      }
    });
  </script>
<script>
// Store cost center data from server
// Backend should always set context.cost_center_details = [...] or []
let costCenterData;
try {
    costCenterData = JSON.parse('{{ cost_center_details | tojson | safe }}');
    if (!Array.isArray(costCenterData)) costCenterData = [];
} catch (e) {
    costCenterData = [];
}
console.log('costCenterData:', costCenterData, typeof costCenterData);

function showCostCenterModal(metricType) {
    const metricTitles = {
        'total_expense': 'Total Expense by Cost Center',
        'total_salaries': 'Total Salaries by Cost Center',
        'total_rents': 'Total Rents by Cost Center',
        'total_electric_bill': 'Total Electric Bill by Cost Center'
    };
    const metricLabels = {
        'total_expense': 'Total Expense',
        'total_salaries': 'Total Salaries',
        'total_rents': 'Total Rents',
        'total_electric_bill': 'Total Electric Bill'
    };
    const metricIcons = {
        'total_expense': 'üí∏',
        'total_salaries': 'üë•',
        'total_rents': 'üè¢',
        'total_electric_bill': '‚ö°'
    };
    const title = metricTitles[metricType];
    const label = metricLabels[metricType];
    const icon = metricIcons[metricType];
    let cardsHTML = '<div class="cost-center-modal-content">';
    cardsHTML += '<div class="overview-cards">';
    costCenterData.forEach(function(item) {
        const value = item[metricType];
        cardsHTML += '<div class="card"><div style="display:flex;flex-direction: row;gap:4rem;text-align: left;justify-content: space-between;">';
            cardsHTML += '<div><div class="card-label">' + item.display_name + '</div>';
            cardsHTML += '<div class="card-value">' + value + '</div></div>';
            cardsHTML += '<div class="card-icon">' + icon + '</div>';
            cardsHTML += '</div>';
        cardsHTML += '</div>';
    });
    cardsHTML += '</div></div>';
    frappe.msgprint({
        title: title,
        message: cardsHTML,
        wide: true,
        indicator: 'blue'
    });
}
window.showCostCenterModal = showCostCenterModal;

let currentDateRange = 'this_month';
let currentFromDate = null;
let currentToDate = null;
let currentCompany = '';
let currentBranch = '';
let isInitialLoad = true;

document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const fromDate = urlParams.get('from_date');
    const toDate = urlParams.get('to_date');
    const company = urlParams.get('company');
    const branch = urlParams.get('branch');
    let range = 'this_month';
    if (fromDate && toDate) {
        const today = new Date();
        const from = new Date(fromDate);
        const to = new Date(toDate);
        const isToday = from.toDateString() === today.toDateString() && to.toDateString() === today.toDateString();
        if (isToday) {
            range = 'today';
        } else {
            // Detect 6m, 3m, 1w, etc. by comparing from/to
            const diffDays = Math.round((to - from) / (1000 * 60 * 60 * 24));
            if (diffDays >= 180 - 2 && diffDays <= 184) range = '6m';
            else if (diffDays >= 90 - 2 && diffDays <= 92) range = '3m';
            else if (diffDays >= 6 && diffDays <= 7) range = '1w';
            else range = 'custom';
        }
        currentFromDate = from;
        currentToDate = to;
        currentToDate.setHours(23, 59, 59);
    }
    setDateRange(range, false);
    if (company) {
        currentCompany = company;
        const companySelect = document.getElementById('companyFilter');
        if (companySelect) companySelect.value = company;
    }
    if (branch) {
        currentBranch = branch;
        const branchSelect = document.getElementById('branchFilter');
        if (branchSelect) branchSelect.value = branch;
    }
    updateFilterDisplay();
    isInitialLoad = false;
});

function calculateDateRange(range) {
        const today = new Date();
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
        switch(range) {
            case 'today':
                return { from: startOfDay, to: endOfDay, display: 'Today' };
            case '1w': {
                // Last 7 days including today
                const weekAgo = new Date(today);
                weekAgo.setDate(today.getDate() - 6);
                return { from: weekAgo, to: endOfDay, display: 'Last 7 Days' };
            }
            case '1m':
                // get last month
                const lastMonth = new Date(today);
                lastMonth.setMonth(today.getMonth() - 1);
                return { from: lastMonth, to: endOfDay, display: 'Last Month' };
            case '3m': {
                // Last 3 months from today (same day-of-month or last valid day)
                const threeMonthsAgo = new Date(today);
                const targetMonth = today.getMonth() - 3;
                threeMonthsAgo.setMonth(targetMonth);
                // If the day rolled over, set to last day of month
                if (threeMonthsAgo.getMonth() !== ((targetMonth + 12) % 12)) {
                    threeMonthsAgo.setDate(0);
                }
                return { from: threeMonthsAgo, to: endOfDay, display: 'Last 3 Months' };
            }
            case '6m': {
                // Last 6 months from today (same day-of-month or last valid day)
                const sixMonthsAgo = new Date(today);
                const targetMonth = today.getMonth() - 6;
                sixMonthsAgo.setMonth(targetMonth);
                if (sixMonthsAgo.getMonth() !== ((targetMonth + 12) % 12)) {
                    sixMonthsAgo.setDate(0);
                }
                return { from: sixMonthsAgo, to: endOfDay, display: 'Last 6 Months' };
            }
            case 'this_year':
            case '1y':
                return { from: new Date(today.getFullYear(), 0, 1), to: endOfDay, display: 'This Year' };
            default:
                return { from: new Date(today.getFullYear(), today.getMonth(), 1), to: endOfDay, display: 'This Month' };
        }
    }

function setDateRange(range, shouldRefresh = true) {
    currentDateRange = range;
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeBtn = document.querySelector(`[data-range="${range}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
    const dates = calculateDateRange(range);
    currentFromDate = dates.from;
    currentToDate = dates.to;
    updateRangeDisplay(range, dates);
    updateFilterDisplay();
    // Always update query params to exact dates
    if (!isInitialLoad && shouldRefresh) {
        refreshDashboardData(dates.from, dates.to);
    }
}

function updateRangeDisplay(range, dates) {
    const displayText = document.getElementById('currentRangeText');
    if (displayText) {
        const fromStr = dates.from.toLocaleDateString();
        const toStr = dates.to.toLocaleDateString();
        displayText.textContent = `Showing: ${dates.display} (${fromStr} - ${toStr})`;
    }
}

function updateFilterDisplay() {
    const chipsContainer = document.getElementById('filterChips');
    let chipsHTML = '';
    if (currentDateRange === 'custom') {
        const fromStr = currentFromDate ? currentFromDate.toLocaleDateString() : '';
        const toStr = currentToDate ? currentToDate.toLocaleDateString() : '';
        chipsHTML += `<span class='filter-chip'>Custom: ${fromStr} - ${toStr} <button class='chip-clear' onclick='clearDateFilter()' title='Clear'>√ó</button></span>`;
    }
    if (currentCompany) {
        chipsHTML += `<span class='filter-chip'>Company: ${getCompanyName(currentCompany)} <button class='chip-clear' onclick='clearCompanyFilter()' title='Clear'>√ó</button></span>`;
    }
    if (currentBranch) {
        chipsHTML += `<span class='filter-chip'>Branch: ${getBranchName(currentBranch)} <button class='chip-clear' onclick='clearBranchFilter()' title='Clear'>√ó</button></span>`;
    }
    chipsContainer.innerHTML = chipsHTML;
}

function refreshDashboardData(fromDate, toDate) {
    frappe.show_alert('Refreshing dashboard data...', 2);
    const fromDateStr = fromDate.toISOString().split('T')[0];
    const toDateStr = toDate.toISOString().split('T')[0];
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('from_date', fromDateStr);
    currentUrl.searchParams.set('to_date', toDateStr);
    if (currentCompany) {
        currentUrl.searchParams.set('company', currentCompany);
    } else {
        currentUrl.searchParams.delete('company');
    }
    if (currentBranch) {
        currentUrl.searchParams.set('branch', currentBranch);
    } else {
        currentUrl.searchParams.delete('branch');
    }
    // Debug: log the filters being sent
    console.log('Refreshing with filters:', {
        from_date: fromDateStr,
        to_date: toDateStr,
        company: currentCompany,
        branch: currentBranch
    });
    window.location.href = currentUrl.toString();
}

// Helper functions for getting company and branch names
function getCompanyName(companyValue) {
    const companySelect = document.getElementById('companyFilter');
    if (companySelect) {
        const option = companySelect.querySelector(`option[value="${companyValue}"]`);
        return option ? option.textContent : companyValue;
    }
    return companyValue;
}

function getBranchName(branchValue) {
    const branchSelect = document.getElementById('branchFilter');
    if (branchSelect) {
        const option = branchSelect.querySelector(`option[value="${branchValue}"]`);
        return option ? option.textContent : branchValue;
    }
    return branchValue;
}

// Filter functions
function setCompanyFilter() {
    const companySelect = document.getElementById('companyFilter');
    currentCompany = companySelect ? companySelect.value : '';
    updateFilterDisplay();
    if (!isInitialLoad) {
        refreshDashboardData(currentFromDate, currentToDate);
    }
}

function setBranchFilter() {
    const branchSelect = document.getElementById('branchFilter');
    currentBranch = branchSelect ? branchSelect.value : '';
    updateFilterDisplay();
    if (!isInitialLoad) {
        refreshDashboardData(currentFromDate, currentToDate);
    }
}

function clearCompanyFilter() {
    currentCompany = '';
    const companySelect = document.getElementById('companyFilter');
    if (companySelect) companySelect.value = '';
    updateFilterDisplay();
    if (!isInitialLoad) {
        refreshDashboardData(currentFromDate, currentToDate);
    }
}

function clearBranchFilter() {
    currentBranch = '';
    const branchSelect = document.getElementById('branchFilter');
    if (branchSelect) branchSelect.value = '';
    updateFilterDisplay();
    if (!isInitialLoad) {
        refreshDashboardData(currentFromDate, currentToDate);
    }
}

function clearDateFilter() {
    setDateRange('this_month');
}

function showCustomDatePicker() {
    const datePicker = document.getElementById('customDatePicker');
    if (datePicker) {
        datePicker.style.display = 'block';
    }
}

function applyCustomDateRange() {
    const fromDateInput = document.getElementById('fromDate');
    const toDateInput = document.getElementById('toDate');
    
    if (fromDateInput && toDateInput && fromDateInput.value && toDateInput.value) {
        const fromDate = new Date(fromDateInput.value);
        const toDate = new Date(toDateInput.value);
        toDate.setHours(23, 59, 59);
        
        currentFromDate = fromDate;
        currentToDate = toDate;
        currentDateRange = 'custom';
        
        updateRangeDisplay('custom', { from: fromDate, to: toDate, display: 'Custom Range' });
        updateFilterDisplay();
        
        const datePicker = document.getElementById('customDatePicker');
        if (datePicker) {
            datePicker.style.display = 'none';
        }
        
        if (!isInitialLoad) {
            refreshDashboardData(fromDate, toDate);
        }
    }
}
</script>

{% endblock %}
