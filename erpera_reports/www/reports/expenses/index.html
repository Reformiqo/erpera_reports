{% extends 'erpera_reports/templates/pages/base.html' %}

{% block page_content %}
    <!-- Filter Section (copied and adapted from reports/selling/index.html) -->
    
    <div class="filter-section">
        <div><h1>Expenses Dashboard</h1></div>
        <div class="filter-container">
            <div class="filter-row-main">
                <div class="filter-group">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-range="today" onclick="setDateRange('today')">1D</button>
                        <button class="filter-btn" data-range="this_week" onclick="setDateRange('this_week')">1W</button>
                        <button class="filter-btn" data-range="this_month" onclick="setDateRange('this_month')">1M</button>
                        <button class="filter-btn" data-range="this_quarter" onclick="setDateRange('this_quarter')">3M</button>
                        <button class="filter-btn" data-range="last_quarter" onclick="setDateRange('last_quarter')">6M</button>
                        <button class="filter-btn" data-range="this_year" onclick="setDateRange('this_year')">1Y</button>
                        <button class="filter-btn custom" data-range="custom" onclick="showCustomDatePicker()">Custom Range</button>
                    </div>
                </div>
                <div class="filter-group">
                    <select id="companyFilter" class="filter-select" style="width: 180px; min-width: 120px; max-width: 200px;" onchange="setCompanyFilter()">
                        <option value="">All Companies</option>
                        {% for company in company_list %}
                            <option value="{{ company.value }}">{{ company.label }}</option>
                        {% endfor %}
                    </select>
                    <select id="branchFilter" class="filter-select" style="width: 180px; min-width: 120px; max-width: 200px;" onchange="setBranchFilter()">
                        <option value="">All Branches</option>
                        {% for branch in branch_list %}
                            <option value="{{ branch.value }}">{{ branch.label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="custom-date-picker" id="customDatePicker" style="display: none;">
                <div class="date-inputs">
                    <div class="date-input-group">
                        <label for="fromDate">From Date:</label>
                        <input type="date" id="fromDate" class="date-input">
                    </div>
                    <div class="date-input-group">
                        <label for="toDate">To Date:</label>
                        <input type="date" id="toDate" class="date-input">
                    </div>
                    <button class="apply-btn" onclick="applyCustomDateRange()">Apply</button>
                </div>
            </div>
            <div class="current-range-display" id="currentFiltersBar">
                <span id="currentRangeText">Showing: This Month</span>
                <span id="filterChips"></span>
            </div>
        </div>
</div>
    

<div class="overview-cards">
    <div class="card clickable-card" onclick="showCostCenterModal('total_expense')">
        <div class="card-content">
            <div class="card-info">
                <div class="card-value">{{ total_expense }}</div>
                <div class="card-label">Total Expense</div>
                <p style="color: #dc2626; font-size: 16px; font-weight: bold;">({{ current_fiscal_year }})</p>
            </div>
            <div class="card-icon">üí∏</div>
        </div>
    </div>
    <div class="card clickable-card" onclick="showCostCenterModal('invoice_count')">
        <div class="card-content">
            <div class="card-info">
                <div class="card-value">{{ invoice_count }}</div>
                <div class="card-label">Total Invoices</div>
                <p style="color: #dc2626; font-size: 16px; font-weight: bold;">({{ current_fiscal_year }})</p>
            </div>
            <div class="card-icon">üìÑ</div>
        </div>
    </div>
    <div class="card clickable-card" onclick="showCostCenterModal('supplier_count')">
        <div class="card-content">
            <div class="card-info">
                <div class="card-value">{{ supplier_count }}</div>
                <div class="card-label">Suppliers</div>
            </div>
            <div class="card-icon">üè¢</div>
        </div>
    </div>
    <div class="card clickable-card" onclick="showCostCenterModal('avg_invoice_value')">
        <div class="card-content">
            <div class="card-info">
                <div class="card-value">{{ avg_invoice_value }}</div>
                <div class="card-label">Avg Expense Value</div>
                <p style="color: #dc2626; font-size: 16px; font-weight: bold;">({{ current_month }})</p>
            </div>
            <div class="card-icon">üìä</div>
        </div>
    </div>
</div>

<div class="section-container">
    <h2 class="section-title">Expense Analysis</h2>
    <div class="charts-row">
        {% set chart_id = 'expenseByBranch' %}
        {% set title = 'Expense by Branch' %}
        {% set backgroundColor = '#dc2626' %}
        {% set chart_type = 'bar' %}
        {% set width = 12 %}
        {% set data_url = 'erpera_reports.expense.get_expense_by_branch' %}
        {% set filters = [
          { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
          { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
          { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
          { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
        ] %}
        {% include "erpera_reports/templates/includes/bar.html" %}

        {% set chart_id = 'expenseByCompany' %}
        {% set title = 'Expense by Company' %}
        {% set backgroundColor = '#dc2626' %}
        {% set chart_type = 'bar' %}
        {% set width = 12 %}
        {% set data_url = 'erpera_reports.expense.get_expense_by_company' %}
        {% set filters = [
            { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
            { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
            { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list }
        ] %}
        {% include "erpera_reports/templates/includes/bar.html" %}

        {% set chart_id = 'expenseSummary' %}
        {% set title = 'Expense Summary' %}
        {% set backgroundColor = '#dc2626' %}
        {% set chart_type = 'bar' %}
        {% set width = 12 %}
        {% set data_url = 'erpera_reports.expense.get_expense_summary' %}
        {% set filters = [
          { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
          { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
          { "label": "Expense Head", "fieldtype": "Select", "fieldname": "item_group", "options": item_group_list },
          { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
          { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
        ] %}
        {% include "erpera_reports/templates/includes/bar.html" %}
    </div>
</div>

<style>
.filter-section{
    display: flex;
    flex-direction: row;
    padding: 35px;
}
.filter-row-main { 
        display: flex;
        flex-flow: column;
        gap: 0.5rem;
        margin-bottom: 1rem;
        align-items: center;
    }
    .filter-group {
    display: flex;
    flex-direction: row;
    gap: 1rem;
    min-width: 140px;
    margin-bottom: 0;
    justify-content: center;
}
.filter-group-label { display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem; white-space: nowrap; }
    .filter-buttons { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 0; }
    .filter-btn { padding: 0.375rem 0.75rem; border: 1px solid #d1d5db; background: #fff; color: #374151; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: all 0.2s ease; white-space: nowrap; }
    .filter-btn:hover { background: #f3f4f6; border-color: #9ca3af; }
    .filter-btn.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }
    .filter-btn.custom { background: #f59e0b; color: #fff; border-color: #f59e0b; }
    .filter-btn.custom:hover { background: #d97706; border-color: #d97706; }
    .filter-select { padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; color: #374151; font-size: 0.875rem; font-weight: 500; cursor: pointer; width: 100%; transition: all 0.2s ease; }
    .filter-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .filter-select:hover { border-color: #9ca3af; }
    .custom-date-picker { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; margin-top: 1rem; }
    .date-inputs { display: flex; flex-wrap: wrap; gap: 1rem; align-items: end; }
    .date-input-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .date-input-group label { font-size: 0.875rem; font-weight: 500; color: #374151; }
    .date-input { padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem; }
    .date-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .apply-btn { padding: 0.5rem 1rem; background: #10b981; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: background-color 0.2s ease; }
    .apply-btn:hover { background: #059669; }
    .current-range-display { margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; text-align: center; }
    .current-range-display span { font-size: 0.875rem; font-weight: 500; color: #0369a1; }
    .filter-chip { display: inline-flex; align-items: center; background: #e0e7ff; color: #3730a3; border-radius: 16px; padding: 2px 10px 2px 8px; margin: 0 4px; font-size: 0.85em; font-weight: 500; }
    .chip-clear { background: none; border: none; color: #a21caf; font-size: 1em; margin-left: 4px; cursor: pointer; line-height: 1; }
    .chip-clear:hover { color: #dc2626; }









.section-container {
    margin: 2rem 0;
    padding: 1rem;
    background: linear-gradient(135deg, #f9e3ff 0%, #67469b 100%);
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #dc2626;
}
.charts-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
}
.clickable-card {
    cursor: pointer;
    transition: all 0.3s ease;
}
.clickable-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.overview-cards {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
}
.card {
    background: linear-gradient(135deg, #e9c0ff 0%, #67469b 100%);
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem 1.5rem 1.5rem 1.5rem;
    min-width: 220px;
    min-height: 120px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    display: flex;
    align-items: stretch;
    flex: 1 1 220px;
    transition: all 0.3s ease;
    position: relative;
    z-index: -1;
}
.card-content {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    height: 100%;
}
.card-info {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: center;
    flex: 1;
    width: 120px;
}
.card-value {
    font-size: 2.1rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.25rem;
    line-height: 1.1;
    overflow-wrap: anywhere;
}
.card-label {
    color: #434c5e;
    font-weight: bold;
    font-size: 28px;
    margin-bottom: 0.25rem;
}
.card-icon {
    font-size: 4.5rem;
    display: flex;
    align-items: center;
    /* flex-shrink: 0; */
    height: 100%;
    background: rgba(0, 0, 0, .1);
    border-radius: 54px;
    width: 115px;
    justify-content: center;
    color: #dc2626;
}
</style>

<script>
// Store cost center data from server
const costCenterData = JSON.parse('{{ cost_center_details | tojson | safe }}');

function showCostCenterModal(metricType) {
    const metricTitles = {
        'total_expense': 'Total Expense by Cost Center',
        'invoice_count': 'Total Invoices by Cost Center',
        'supplier_count': 'Unique Suppliers by Cost Center',
        'avg_invoice_value': 'Average Expense Value by Cost Center'
    };
    const metricLabels = {
        'total_expense': 'Total Expense',
        'invoice_count': 'Total Invoices',
        'supplier_count': 'Unique Suppliers',
        'avg_invoice_value': 'Average Expense Value'
    };
    const metricIcons = {
        'total_expense': 'üí∏',
        'invoice_count': 'üìÑ',
        'supplier_count': 'üè¢',
        'avg_invoice_value': 'üìä'
    };
    const title = metricTitles[metricType];
    const label = metricLabels[metricType];
    const icon = metricIcons[metricType];
    let cardsHTML = '<div class="cost-center-modal-content">';
    cardsHTML += '<div class="overview-cards">';
    costCenterData.forEach(function(item) {
        const value = item[metricType];
        cardsHTML += '<div class="card">';
        cardsHTML += '<div class="card-icon">' + icon + '</div>';
        cardsHTML += '<div class="card-value">' + value + '</div>';
        cardsHTML += '<div class="card-label">' + item.display_name + '</div>';
        cardsHTML += '</div>';
    });
    cardsHTML += '</div></div>';
    frappe.msgprint({
        title: title,
        message: cardsHTML,
        wide: true,
        indicator: 'blue'
    });
}
</script>

{% endblock %}
