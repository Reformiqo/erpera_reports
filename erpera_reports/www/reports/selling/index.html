{% extends 'erpera_reports/templates/pages/base.html' %}

{% block page_content %}
    <div class="overview-cards">
        <div class="card clickable-card" onclick="showCostCenterModal('total_sales')">
            <div class="card-icon products">ðŸ’°</div>
            <div class="card-value">{{ total_sales }} </div>
            <div class="card-label">Total Sales</div>
            <p style="color: #dc2626; font-size: 12px; font-weight: 500;">({{ current_fiscal_year }})</p>
        </div>
        <div class="card clickable-card" onclick="showCostCenterModal('invoice_count')">
            <div class="card-icon orders">ðŸ“„</div>
            <div class="card-value py-0">{{ invoice_count }} </div>
            
            <div class="card-label">Total Invoices</div>
            <p style="color: #dc2626; font-size: 12px; font-weight: 500;">({{ current_fiscal_year }})</p>
        </div>
        <div class="card clickable-card" onclick="showCostCenterModal('customer_count')">
            <div class="card-icon stock">ðŸ‘¥</div>
            <div class="card-value">{{ customer_count }}</div>
            <div class="card-label">Unique Customers</div>
        </div>
        <div class="card clickable-card" onclick="showCostCenterModal('avg_invoice_value')">
            <div class="card-icon out-of-stock">ðŸ“Š</div>
            <div class="card-value">{{ avg_invoice_value }} </div>
            <div class="card-label">Average Sale Value</div>
            <p style="color: #dc2626; font-size: 12px; font-weight: 500;">({{ current_month }})</p>
        </div>
    </div>

    
    <div class="section-container">
        <h2 class="section-title">Total Selling</h2>
        <div class="charts-row">
            {% set chart_id = 'branchWiseSelling' %}
            {% set title = 'Branch Wise Selling' %}
            {% set backgroundColor = '#7c3aed' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.selling.get_branch_wise_selling' %}
            {% set filters = [
              { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
              { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
              { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
              { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
            ] %}
            {% include "erpera_reports/templates/includes/bar.html" %}

            {% set chart_id = 'companyWiseSelling' %}
            {% set title = 'Company Wise Selling' %}
            {% set backgroundColor = '#7c3aed' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.selling.get_company_wise_selling' %}
            {% set filters = [
                { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
                { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
                { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list }
            ] %}
            {% include "erpera_reports/templates/includes/bar.html" %}

            {% set chart_id = 'sellingSummary' %}
            {% set title = 'Selling Summary' %}
            {% set backgroundColor = '#7c3aed' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.selling.get_selling_summary' %}
            {% set filters = [
              { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
              { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
              { "label": "Item", "fieldtype": "Select", "fieldname": "item", "options": item_list },
              { "label": "Item Group", "fieldtype": "Select", "fieldname": "item_group", "options": item_group_list },
              { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
              { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
            ] %}
            {% include "erpera_reports/templates/includes/bar.html" %}
        </div>
    </div>

    <div class="section-container">
        <h2 class="section-title">Consolidated Total Selling</h2>
        <div class="charts-row">
            {% set chart_id = 'consolidatedTotalSelling' %}
            {% set title = 'Consolidated Total Selling' %}
            {% set backgroundColor = '#7c3aed' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.selling.consolidated_total_selling' %}
            {% set filters = [
              { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
              { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
              { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
              { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
            ] %}
            {% include "erpera_reports/templates/includes/bar.html" %}

            {% set chart_id = 'entityWiseSelling' %}
            {% set title = 'Entity Wise Selling' %}
            {% set backgroundColor = '#7c3aed' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.selling.get_entity_wise_selling' %}
            {% set filters = [
              { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
              { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
              { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
              { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
            ] %}
            {% include "erpera_reports/templates/includes/bar.html" %}
        </div>
        
    </div>

    <div class="section-container">
        <h2 class="section-title">Top Customers</h2>
        <div class="charts-row">
            {% set chart_id = 'topCustomersByBranch' %}
            {% set title = 'Top Customers by Branch' %}
            {% set backgroundColor = '#7c3aed' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.selling.get_top_customers_by_branch' %}
            {% set filters = [
                { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
                { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
                { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list },
                { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
            ] %}
            {% include "erpera_reports/templates/includes/bar.html" %}

            {% set chart_id = 'topCustomersByCompany' %}
            {% set title = 'Top Customers by Company' %}
            {% set backgroundColor = '#7c3aed' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.selling.get_top_customers_by_company' %}
            {% set filters = [
                { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
                { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
                { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list }
            ] %}
            {% include "erpera_reports/templates/includes/bar.html" %}
        </div>
    </div>

    <div class="section-container">
        <h2 class="section-title">Consolidated Top Customers</h2>
        <div class="charts-row">
            {% set chart_id = 'consolidatedTopCustomers' %}
            {% set title = 'Top 10 Customers Overall' %}
            {% set backgroundColor = '#7c3aed' %}
            {% set chart_type = 'bar' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.selling.get_consolidated_top_customers' %}
            {% set filters = [
                { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
                { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" }
            ] %}
            {% include "erpera_reports/templates/includes/bar.html" %}
        </div>
    </div>

    <div class="section-container">
        <h2 class="section-title">Top Selling Products</h2>
        <div class="charts-row">
            {% set chart_id = 'topSellingProductsByBranch' %}
            {% set title = 'Top Selling Products by Branch' %}
            {% set data_url = 'erpera_reports.selling.get_top_selling_products_by_branch' %}
            {% set width = 12 %}
            {% set filters = [
                { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
                { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
                { "label": "Branch", "fieldtype": "Select", "fieldname": "branch", "options": branch_list }
            ] %}
            {% include "erpera_reports/templates/includes/multi_pie.html" %}

            {% set chart_id = 'topSellingProductsByCompany' %}
            {% set title = 'Top Selling Products by Company' %}
            {% set data_url = 'erpera_reports.selling.get_top_selling_products_by_company' %}
            {% set width = 12 %}
            {% set filters = [
                { "label": "From Date", "fieldtype": "Date", "fieldname": "from_date" },
                { "label": "To Date", "fieldtype": "Date", "fieldname": "to_date" },
                { "label": "Company", "fieldtype": "Select", "fieldname": "company", "options": company_list }
            ] %}
            {% include "erpera_reports/templates/includes/multi_pie.html" %}
        </div>
    </div>

    <div class="section-container">
        <h2 class="section-title">Consolidated Top Selling Products</h2>
        <div class="charts-row">
            {% set chart_id = 'consolidatedTopSellingProducts' %}
            {% set title = 'Top 10 Products Overall' %}
            {% set backgroundColor = '#7c3aed' %}
            {% set chart_type = 'pie' %}
            {% set width = 12 %}
            {% set data_url = 'erpera_reports.selling.get_consolidated_top_selling_products' %}
            {% include "erpera_reports/templates/includes/doughnut.html" %}
        </div>
    </div>

    <!-- Space for future sections -->

    <style>
    .section-container {
        margin: 2rem 0;
        padding: 1rem;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #7c3aed;
    }

    .charts-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .clickable-card {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .clickable-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .cost-center-modal-content {
        max-height: 70vh;
        overflow-y: auto;
    }

    .cost-center-modal-content .overview-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        padding: 1rem 0;
    }

    .cost-center-modal-content .card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .cost-center-modal-content .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .cost-center-modal-content .card-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .cost-center-modal-content .card-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }

    .cost-center-modal-content .card-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }

    .cost-center-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .cost-center-table th,
    .cost-center-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }

    .cost-center-table th {
        background-color: #f9fafb;
        font-weight: 600;
        color: #374151;
    }

    .cost-center-table tr:hover {
        background-color: #f9fafb;
    }

    .cost-center-name {
        font-weight: 500;
        color: #1f2937;
    }

    .cost-center-value {
        font-weight: 600;
        color: #7c3aed;
    }
    </style>

    <script>
    // Store cost center data from server
    const costCenterData = JSON.parse('{{ cost_center_details | tojson | safe }}');

    function showCostCenterModal(metricType) {
        const metricTitles = {
            'total_sales': 'Total Sales by Cost Center',
            'invoice_count': 'Total Invoices by Cost Center', 
            'customer_count': 'Unique Customers by Cost Center',
            'avg_invoice_value': 'Average Sale Value by Cost Center'
        };
        
        const metricLabels = {
            'total_sales': 'Total Sales',
            'invoice_count': 'Total Invoices',
            'customer_count': 'Unique Customers', 
            'avg_invoice_value': 'Average Sale Value'
        };
        
        const metricIcons = {
            'total_sales': 'ðŸ’°',
            'invoice_count': 'ðŸ“„',
            'customer_count': 'ðŸ‘¥',
            'avg_invoice_value': 'ðŸ“Š'
        };
        
        const title = metricTitles[metricType];
        const label = metricLabels[metricType];
        const icon = metricIcons[metricType];
        
        // Create number cards HTML
        let cardsHTML = '<div class="cost-center-modal-content">';
        cardsHTML += '<div class="overview-cards">';
        
        // Add number cards for each cost center
        costCenterData.forEach(function(item) {
            const value = item[metricType];
            cardsHTML += '<div class="card">';
            cardsHTML += '<div class="card-icon products">' + icon + '</div>';
            cardsHTML += '<div class="card-value">' + value + '</div>';
            cardsHTML += '<div class="card-label">' + item.display_name + '</div>';
            cardsHTML += '</div>';
        });
        
        cardsHTML += '</div></div>';
        
        // Show modal using frappe.msgprint
        frappe.msgprint({
            title: title,
            message: cardsHTML,
            wide: true,
            indicator: 'blue'
        });
    }
    </script>

{% endblock %}

   
